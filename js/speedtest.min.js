/* 2016-04-20 https://github.com/cgkineo/speedtest */
!function(){function e(){for(var e=0,t={};e<arguments.length;e++){var n=arguments[e];for(var o in n)t[o]=n[o]}return t}function t(e,t){for(var n in t)e[n]=t[n];return e}function n(t){function o(n,i,a){var s;if("undefined"!=typeof document){if(arguments.length>1){if(a=e({path:"/"},o.defaults,a),"number"==typeof a.expires){var l=new Date;l.setMilliseconds(l.getMilliseconds()+864e5*a.expires),a.expires=l}try{s=JSON.stringify(i),/^[\{\[]/.test(s)&&(i=s)}catch(c){}return i=t.write?t.write(i,n):encodeURIComponent(String(i)).replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),n=encodeURIComponent(String(n)),n=n.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),n=n.replace(/[\(\)]/g,escape),document.cookie=[n,"=",i,a.expires&&"; expires="+a.expires.toUTCString(),a.path&&"; path="+a.path,a.domain&&"; domain="+a.domain,a.secure?"; secure":""].join("")}n||(s={});for(var r=document.cookie?document.cookie.split("; "):[],m=/(%[0-9A-Z]{2})+/g,d=0;d<r.length;d++){var u=r[d].split("="),_=u[0].replace(m,decodeURIComponent),p=u.slice(1).join("=");'"'===p.charAt(0)&&(p=p.slice(1,-1));try{if(p=t.read?t.read(p,_):t(p,_)||p.replace(m,decodeURIComponent),this.json)try{p=JSON.parse(p)}catch(c){}if(n===_){s=p;break}n||(s[_]=p)}catch(c){}}return s}}return o.set=o,o.get=function(e){return o(e)},o.getJSON=function(){return o.apply({json:!0},[].slice.call(arguments))},o.defaults={},o.remove=function(t,n){o(t,"",e(n,{expires:-1}))},o.withConverter=n,o}if(!window.speedtest){var o=n(function(){}),i={domloaded:!1,html:document.getElementsByTagName("html")[0],debounce:function(e,t){var n=null;return function(){n&&clearTimeout(n),n=setTimeout(function(){e()},t||17)}},one:function(e,t,n){e["_speedtest"+t]=i.callbackOnce(n,e),document.addEventListener?e.addEventListener(t,e["_speedtest"+t],!1):document.attachEvent&&e.attachEvent("on"+t,e["_speedtest"+t])},on:function(e,t,n){document.addEventListener?e.addEventListener(t,n,!1):document.attachEvent&&e.attachEvent("on"+t,n)},callbackOnce:function(e,t){var n=function(o){e(),i.off(t,o.type,n)};return n},off:function(e,t,n){document.addEventListener?e.removeEventListener(t,n):document.attachEvent&&e.detachEvent("on"+t,n)},attr:function(e,t,n){return void 0===n?e.getAttribute(t)||"":void e.setAttribute(t,n)},onDocumentLoaded:function(e,t){return i.domloaded&&e(),t?void setTimeout(e,t):void(document.addEventListener?i.one(document,"DOMContentLoaded",e):document.attachEvent&&i.on(document,"readystatechange",function(){"interactive"==document.readyState&&e()}))},addClass:function(e,t){for(var n=i.attr(e,"class").split(" "),o=n.length-1,a=-1;o>a;o--){if(n[o].toLowerCase()===t)return;""===n[o]&&n.splice(o,1)}n.push(t),i.attr(e,"class",n.join(" "))},removeClass:function(e,t){for(var n=i.attr(e,"class").split(" "),o=n.length-1,a=-1;o>a;o--)n[o].toLowerCase()===t&&n.splice(o,1),""===n[o]&&n.splice(o,1);i.attr(e,"class",n.join(" "))}},a=window.speedtest={kbps:0,low_kbps:1e7,config:function(e){return a.config.imagesURL=e.imagesURL,a.config.interval=e.interval||a.config.interval,a.config.sample_age=e.sample_age||a.config.sample_age,a.config.idle_timeout=e.idle_timeout||a.config.idle_timeout,a.config.slow_threshold_kbps=e.slow_threshold_kbps||a.config.slow_threshold_kbps,a.config.offline_threshold_kbps=e.offline_threshold_kbps||a.config.offline_threshold_kbps,a.config.no_wait_for_document=e.no_wait_for_document||a.config.no_wait_for_document,a},test:function(e){for(var t=0,n=s.images.length;n>t;t++){var l=s.images[t];l.url=a.config.imagesURL+"/"+l.name,s.images[t].index=t}return s.bandwidth({completedCount:0,complete:function(){var t=1e3*s.bytes_per_millisecond,n=8*t,l=n/1024;a.kbps=Math.round(l),a.name=s.get_speed_name(a.kbps);var c=a.low_name,r=a.low_kbps;a.kbps<a.low_kbps&&(c=a.name,r=a.kbps),s.overtime.push({timestamp:(new Date).getTime(),kbps:a.kbps});var m=s.calculateOvertime();m&&m.kbps<=a.kbps&&(c=m.name,r=m.kbps),o.set("speedtest",JSON.stringify({low_name:c,low_kbps:r})),a.low_name&&a.low_name!==c&&i.removeClass(i.html,"speedtest-"+a.low_name),i.addClass(i.html,"speedtest-"+c),a.low_name=c,a.low_kbps=r,"function"==typeof e&&e.call(a,c,r)}}),a},onchange:function(e,t){if(t=t||{},void 0===t.immediate&&(t.immediate=!0),void 0===t.on_rate_change&&(t.on_rate_change=!1),s.inchange=!1,"function"!=typeof e)throw"onchange requires a callback function";return s.onchanges.push({callback:e,options:t}),e._speedtestid=s.uid++,s.startChangeTimeout(t&&t.immediate),s.onInteraction(),a},offchange:function(e){for(var t=s.onchanges.length-1,n=-1;t>n;t--)(void 0===e||s.onchanges[t].callback._speedtestid===e._speedtestid)&&s.onchanges.splice(t,1);return 0===s.onchanges.length&&s.finishChangeTimeout(),a}},s={imgs:[],received_bytes:0,overall_milliseconds:0,bytes_per_millisecond:0,min_timeout:500,max_timeout:2e3,allow_timeout:!1,timedout:!1,onchanges:[],change_timeout:null,interaction_timeout:null,uid:0,previous_low_kbps:null,previous_low_name:null,overtime:[],images:[{name:"image-0.gif",type:"overhead",size:35},{name:"image-1.png",type:"minimum",size:440},{name:"image-4.png",type:"reset",size:40836},{name:"image-6.png",size:381756}],calculateOvertime:function(){for(var e=(new Date).getTime(),t=1e9,n=0,o=0,i=s.overtime.length-1,l=-1;i>l;i--){var c=s.overtime[i];e-c.timestamp>a.config.sample_age?s.overtime.splice(i,1):(c.kbps<t&&(t=c.kbps),o+=c.kbps,n++)}if(0!==n){var r=o/n,m={};return m.kbps=Math.round((t+r)/2),m.name=s.get_speed_name(m.kbps),m}},startChangeTimeout:function(e){s.change_timeout||(e&&(s.inchange=!0,a.test(s.performChange)),s.change_timeout=setInterval(function(){s.inchange||(s.inchange=!0,a.test(s.performChange))},a.config.interval))},finishChangeTimeout:function(){clearInterval(s.change_timeout),s.change_timeout=null},performChange:function(){s.inchange=!1;for(var e=0,t=s.onchanges.length;t>e;e++)(null===s.previous_low_name||s.previous_low_name!==a.low_name||s.onchanges[e].options.on_rate_change)&&(null===s.previous_low_kbps||s.previous_low_kbps!==a.low_kbps)&&s.onchanges[e].callback(a.low_name,a.low_kbps);s.previous_low_name=a.low_name,s.previous_low_kbps=a.low_kbps},get_speed_name:function(e){return a.config.offline_threshold_kbps>=e?"offline":a.config.slow_threshold_kbps>=e?"slow":"fast"},bandwidth:function(e){function t(){s.bandwidth_unit({imageIndex:0,complete:function(t){s.bandwidth_count.call(a,e,t);for(var n=1,o=s.images.length;o>n;n++)s.bandwidth_unit({imageIndex:n,complete:function(t){s.bandwidth_count.call(a,e,t)}});setTimeout(function(){s.timedout||(s.timedout=!0,s.allow_timeout&&(s.cancelled=!0,s.bandwidth_complete.call(a,e)))},s.min_timeout),setTimeout(function(){s.cancelled||(s.cancelled=!0,s.bandwidth_complete.call(a,e))},s.max_timeout)}})}(new Date).getTime();s.overall_milliseconds=0,s.received_bytes=0,s.timedout=!1,s.cancelled=!1,s.allow_timeout=!1,s.bytes_per_millisecond=0,e.completed=!1,i.domloaded?t():i.onDocumentLoaded(t,a.config.no_wait_for_document)},bandwidth_unit:function(e){function t(){var t=(new Date).getTime();o.error=!1,o.milliseconds=t-c,e.complete.call(a,o)}function n(){(new Date).getTime();o.error=!0,o.milliseconds=1e8,e.complete.call(a,o)}var o=s.images[e.imageIndex],l=document.createElement("img"),c=(new Date).getTime();i.one(l,"load",t),i.one(l,"error",n),s.imgs.push(l),l.setAttribute("src",o.url+"?t="+c)},bandwidth_count:function(e,t,n){if(e.completedCount++,t.error)return s.overall_milliseconds=0,s.received_bytes=0,s.bytes_per_millisecond=0,s.bandwidth_complete(e);if("overhead"===t.type)return void(s.overhead_milliseconds=t.milliseconds);s.allow_timeout=!0,"reset"===t.type&&(s.overall_milliseconds=0,s.received_bytes=0);var o=t.milliseconds-s.overhead_milliseconds;return 0>o&&(o=Math.abs(o)),s.overall_milliseconds+=o,s.received_bytes+=t.size,s.bytes_per_millisecond=s.received_bytes/s.overall_milliseconds,s.timedout?s.bandwidth_complete(e):void("minimum"!==t.type&&(e.completedCount===s.images.length||n)&&s.bandwidth_complete(e))},bandwidth_complete:function(e){if(!e.completed){e.completed=!0;for(var t=0,n=s.imgs.length;n>t;t++){var o=s.imgs[t];i.off(o,"load",o._speedtestload),i.off(o,"error",o._speedtesterror),i.attr(o,"src","")}s.imgs=[],"function"==typeof e.complete&&e.complete()}},onInteraction:function(){var e=(new Date).getTime(),t=!1;e-s.last_interaction>a.min_timeout&&(t=!0),s.last_interaction=e,clearTimeout(s.interaction_timeout),s.interaction_timeout=setTimeout(s.finishChangeTimeout,a.config.idle_timeout),s.startChangeTimeout(t)}};t(a.config,{imagesURL:null,interval:2e4,sample_age:6e4,idle_timeout:6e4,offline_threshold_kbps:0,slow_threshold_kbps:1e3,no_wait_for_document:!1}),i.on(document,"click",s.onInteraction),i.on(document,"keyup",s.onInteraction),i.on(document,"scroll",i.debounce(s.onInteraction,250)),i.onDocumentLoaded(function(){i.domloaded=!0},a.config.no_wait_for_document);var l=o.get("speedtest");l?(l=JSON.parse(l),a.low_name=l.low_name,a.low_kbps=l.low_kbps,i.addClass(i.html,"speedtest-"+a.low_name)):(a.low_name="slow",a.low_kbps=25,i.addClass(i.html,"speedtest-slow"))}}();